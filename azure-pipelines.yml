trigger:
  branches:
    include:
      - main
      - dev

variables:
  environment: 'dev'
  location: 'eastus'

  resourceGroupName: 'shamlin-rg-$(environment)'
  appServicePlanName: 'shamlin-asp-$(environment)'
  appServiceName: 'shamlin-app-$(environment)'
  appServiceSku: 'B1'

  azureServiceConnection: 'Shamlinzure'

stages:

# =================== CI ===================

- stage: CI
  displayName: "CI - Terraform Plan"
  jobs:
    - job: terraform_ci
      displayName: "Terraform Init/Fmt/Validate/Plan"
      pool:
        name: 'Default'

      steps:
        - checkout: self

        # Install Terraform
        - script: |
            echo "Installing Terraform..."
            curl -sLo terraform.zip https://releases.hashicorp.com/terraform/1.9.5/terraform_1.9.5_linux_amd64.zip
            sudo unzip -o terraform.zip -d /usr/local/bin
            terraform -version
          displayName: "Install Terraform"

        # Azure login and run Terraform commands
        - task: AzureCLI@2
          displayName: "Terraform init/fmt/validate/plan"
          inputs:
            azureSubscription: '$(azureServiceConnection)'
            scriptType: 'bash'
            scriptLocation: 'inlineScript'
            workingDirectory: 'infra'
            inlineScript: |
              set -e

              echo "Azure CLI logged in. Running Terraform in environment: $(environment)"

              terraform init

              echo "Running terraform fmt -check"
              terraform fmt -check

              echo "Running terraform validate with env-specific behavior..."
              if [ "$(environment)" = "prod" ]; then
                echo "Strict validation for PROD"
                terraform validate
              else
                echo "Lenient validation for DEV/STAGE"
                terraform validate || echo "Validation issues detected but allowed in non-prod"
              fi

              echo "Running terraform plan..."
              terraform plan \
                -out=tfplan \
                -var="environment=$(environment)" \
                -var="location=$(location)" \
                -var="resource_group_name=$(resourceGroupName)" \
                -var="app_service_plan_name=$(appServicePlanName)" \
                -var="app_service_name=$(appServiceName)" \
                -var="app_service_sku=$(appServiceSku)"

        # Publish plan as artifact
        - publish: infra/tfplan
          artifact: tfplan
          displayName: "Publish Terraform plan artifact"

# =================== CD STAGE ===================



# =================== CD STAGE ===================
- stage: CD
  displayName: "CD - Terraform Apply"
  dependsOn: CI
  condition: succeeded()

  jobs:
    - deployment: terraform_cd
      displayName: "Terraform Apply Deployment"
      environment: "prod"      
      strategy:
        runOnce:
          deploy:
            steps:

              - checkout: self

              - download: current
                artifact: tfplan
                displayName: "Download Terraform plan artifact"

              - script: |
                  echo "Installing Terraform..."
                  curl -sLo terraform.zip https://releases.hashicorp.com/terraform/1.9.5/terraform_1.9.5_linux_amd64.zip
                  sudo unzip -o terraform.zip -d /usr/local/bin
                  terraform -version
                displayName: "Install Terraform"

              - task: AzureCLI@2
                displayName: "Terraform apply"
                inputs:
                  azureSubscription: '$(azureServiceConnection)'
                  scriptType: 'bash'
                  scriptLocation: 'inlineScript'
                  workingDirectory: 'infra'
                  inlineScript: |
                    set -e

                    echo "Running terraform init..."
                    terraform init

                    echo "Applying plan..."
                    terraform apply "tfplan"
